<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yotoqxona Boshqaruvi</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-hotel me-2"></i>Yotoqxona Boshqaruvi
            </a>
            <div class="navbar-text text-white">
                <i class="fas fa-clock me-1"></i>
                <span id="current-time">{{ now.strftime('%Y-%m-%d %H:%M:%S') }}</span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Statistika kartalari -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card stat-card bg-info text-white">
                    <div class="card-body">
                        <h5><i class="fas fa-users"></i> Jami Foydalanuvchilar</h5>
                        <h2 id="total-users">{{ total_users }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card bg-warning text-dark">
                    <div class="card-body">
                        <h5><i class="fas fa-broom"></i> So'ngi Tozalash</h5>
                        <h6 id="last-cleanup">
                            {% if last_cleanup %}
                                {{ last_cleanup.cleanup_time.strftime('%Y-%m-%d %H:%M') }}
                            {% else %}
                                Hech qachon
                            {% endif %}
                        </h6>
                        <small id="last-cleanup-count">
                            {% if last_cleanup %}
                                {{ last_cleanup.records_deleted }} ta o'chirildi
                            {% endif %}
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card bg-danger text-white">
                    <div class="card-body">
                        <h5><i class="fas fa-trash"></i> Tozalashni Boshqarish</h5>
                        <button id="manual-cleanup" class="btn btn-light btn-sm mb-2">
                            <i class="fas fa-play"></i> HOZIR TOZALASH
                        </button>
                        <button id="add-test-users" class="btn btn-outline-light btn-sm">
                            <i class="fas fa-plus"></i> TEST MA'LUMOT QO'SHISH
                        </button>
                        <p class="small mt-2">Keyingi avtomatik tozalash: <span id="next-cleanup">Dushanba 00:00</span></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Foydalanuvchilar jadvali -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-table"></i> Foydalanuvchilar Ro'yxati ({{ users|length }} ta)</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>To'liq Ism</th>
                                        <th>Xona Raqami</th>
                                        <th>Qo'shilgan Sana</th>
                                        <th>Oxirgi Faollik</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in users %}
                                    <tr>
                                        <td>{{ user.id }}</td>
                                        <td>{{ user.full_name }}</td>
                                        <td><span class="badge bg-primary">{{ user.room_number }}</span></td>
                                        <td>
                                            {% if user.created_at %}
                                                {{ user.created_at.strftime('%Y-%m-%d %H:%M') }}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if user.last_active_at %}
                                                {{ user.last_active_at.strftime('%Y-%m-%d %H:%M') }}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">
                                            <i class="fas fa-database fa-2x mb-3"></i><br>
                                            Foydalanuvchilar topilmadi.<br>
                                            <small>"Test ma'lumot qo'shish" tugmasini bosing yoki bazangizga ma'lumot qo'shing.</small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tozalash tarixi -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-history"></i> Tozalash Tarixi</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group">
                            {% for log in logs %}
                            <div class="list-group-item">
                                <small class="text-muted">{{ log.cleanup_time.strftime('%Y-%m-%d %H:%M') }}</small><br>
                                <strong>{{ log.records_deleted }} ta</strong> yozuv tozalandi<br>
                                <small class="text-muted">Status: {{ log.status }}</small>
                            </div>
                            {% else %}
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-clock fa-2x mb-2"></i><br>
                                Tozalash tarixi mavjud emas
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script>
        // Vaqtni yangilash
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = 
                now.toISOString().slice(0, 19).replace('T', ' ');
        }
        setInterval(updateTime, 1000);
        updateTime();

        // Keyingi tozalashni hisoblash (har dushanba 00:00)
        function calculateNextCleanup() {
            const now = new Date();
            const daysUntilMonday = (8 - now.getDay()) % 7 || 7;
            const nextMonday = new Date(now);
            nextMonday.setDate(now.getDate() + daysUntilMonday);
            nextMonday.setHours(0, 0, 0, 0);
            
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return nextMonday.toLocaleDateString('uz-UZ', options) + ' 00:00';
        }
        document.getElementById('next-cleanup').textContent = calculateNextCleanup();

        // Qo'lda tozalash
        document.getElementById('manual-cleanup').addEventListener('click', async function() {
            if (!confirm('D I Q Q A T !\n\nHaqiqatan ham BAZANING BARCHA FOYDALANUVCHILARINI o\'chirib tashlamoqchimisiz?\n\nBu amalni ortga qaytarib bo\'lmaydi!')) {
                return;
            }
            
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Tozalanmoqda...';
            
            try {
                const response = await fetch('/api/cleanup/manual', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    alert(`✅ Muvaffaqiyatli!\n${result.deleted} ta foydalanuvchi o'chirildi.`);
                    location.reload(); // Sahifani yangilash
                } else {
                    alert('❌ Xatolik: ' + result.message);
                }
            } catch (error) {
                alert('❌ Server xatosi: ' + error.message);
            }
            
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-play"></i> HOZIR TOZALASH';
        });

        // Test ma'lumot qo'shish
        document.getElementById('add-test-users').addEventListener('click', async function() {
            if (!confirm('Bazaga 5 ta test foydalanuvchi qo\'shilsinmi?')) {
                return;
            }
            
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Qo\'shilmoqda...';
            
            try {
                const response = await fetch('/api/add-test-users', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    alert(`✅ ${result.added} ta test foydalanuvchi qo'shildi!`);
                    location.reload();
                } else {
                    alert('❌ Xatolik: ' + result.message);
                }
            } catch (error) {
                alert('❌ Server xatosi: ' + error.message);
            }
            
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-plus"></i> TEST MA\'LUMOT QO\'SHISH';
        });

        // Har 30 soniyada statistika yangilash
        setInterval(async () => {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                document.getElementById('total-users').textContent = data.total_users;
                if (data.last_cleanup !== 'Hech qachon') {
                    document.getElementById('last-cleanup').textContent = data.last_cleanup;
                    document.getElementById('last-cleanup-count').textContent = 
                        `${data.records_deleted_last} ta o'chirildi`;
                }
            } catch (error) {
                console.log('Statistika yangilashda xatolik:', error);
            }
        }, 30000);
    </script>
</body>
</html>